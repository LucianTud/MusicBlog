{% extends "blog/base.html" %}
{% load embed_filters %}
{% block content %}

    {% for post in posts %}
        <article class="media content-section">
            <img class="rounded-circle article-img" src="{{ post.author.profile.image.url }}">
            <div class="media-body">
                <div class="article-metadata">
                    <a class="mr-2" href="{% url 'user-posts' post.author.username %}">{{ post.author }}</a>
                    <small class="text-muted">{{ post.date_posted|date:"F d, Y | h:i a" }}</small>
                </div>
                <h2><a class="article-title" href="{% url 'post-detail' post.id %}">{{ post.title }}</a></h2>
                <p class="article-content">{{ post.content|safe }}</p>

                {% if post.video_url %}
                    <div class="mt-3">
                        <h5></h5>
                        <div class="embed-responsive embed-responsive-16by9">
                            <iframe class="embed-responsive-item"
                                    src="{{ post.video_url|embed_url }}"
                                    frameborder="0"
                                    allowfullscreen>
                            </iframe>
                        </div>
                    </div>
                    <br>
                {% endif %}

                <!-- Butonul de like cu AJAX -->
                <form class="like-form" action="{% url 'post-like' post.pk %}" method="POST">
                    {% csrf_token %}
                    {% if user.is_authenticated %}
                        <button type="button" class="like-button" data-post-id="{{ post.pk }}">
                            {% if post.id in liked_posts %}
                                💔 Unlike
                            {% else %}
                                ❤️ Like
                            {% endif %}
                        </button>
                    {% else %}
                        <a href="{% url 'login' %}">Loghează-te ca să dai like</a>
                    {% endif %}
                </form>

                <!-- Afișăm numărul de like-uri -->
                <p>{{ post.likes.count }} like{{ post.likes.count|pluralize }}</p>

            </div>
        </article>
    {% endfor %}

    <script>
        // AJAX pentru Like/Unlike
        document.querySelectorAll('.like-button').forEach(button => {
            button.addEventListener('click', function(e) {
                const postId = this.getAttribute('data-post-id');
                const form = this.closest('form');
                const csrfToken = form.querySelector('[name="csrfmiddlewaretoken"]').value;

                fetch('{% url "post-like" 0 %}'.replace('0', postId), {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': csrfToken
                    },
                    body: JSON.stringify({ 'action': 'like' })
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        if (data.liked) {
                            this.innerHTML = '💔 Unlike';
                        } else {
                            this.innerHTML = '❤️ Like';
                        }
                        // Poți actualiza și numărul de like-uri dacă vrei
                    }
                });
            });
        });
    </script>

{% endblock content %}


